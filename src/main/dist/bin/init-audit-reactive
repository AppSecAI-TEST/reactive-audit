#!/bin/bash

# Uses uname to detect if we're in the odd cygwin environment.
is_cygwin() {
  local os=$(uname -s)
  case "$os" in
    CYGWIN*) return 0 ;;
    *)  return 1 ;;
  esac
}

# This can fix cygwin style /cygdrive paths so we get the
# windows style paths.
cygwinpath() {
  local file="$1"
  if is_cygwin; then
    echo $(cygpath -w $file)
  else
    echo $file
  fi
}

echo XXXX=`cygwinpath a/b`
echo YYYY=`cygwinpath a\\b`

if [ -z "$AUDIT_REACTIVE_HOME" ]; then
    AUDIT_REACTIVE_HOME=$(cygwinpath `dirname $0`)
else
    AUDIT_REACTIVE_HOME=$(cygwinpath $AUDIT_REACTIVE_HOME)
fi
if [ -z "$FRAMEWORKS_HOME" ]; then
    FRAMEWORKS_HOME=$AUDIT_REACTIVE_HOME/etc
else
    FRAMEWORKS_HOME=$(cygwinpath $FRAMEWORKS_HOME)
fi


# Parse args
while [ "$1" != "" ]; do
    PARAM=$1
    case $PARAM in
        -s)
            SILENT=true
            ;;
        -d)
            DEBUG=true
            ;;
        *)
            FRAMEWORK="$1"
            CONF="-DauditReactive=$FRAMEWORKS_HOME/$1.properties"
            ;;
    esac
    shift
done

WEAVER="-javaagent:${HOME}/lib/aspectjweaver.jar"
XBOOT="-Xbootclasspath/p:${HOME}/lib/audit-reactive.jar;${HOME}/lib/audit-reactive-lib.jar"
AUDIT_OPTS="${CONF} ${WEAVER} ${XBOOT}"

if [[ "$FRAMEWORK" == "" && "$SILENT" != "true" ]]; then
    echo 'Now you can use the environment variable AUDIT_OPTS for launch Java program.'
    echo ' set JAVA_OPTS=$AUDIT_OPTS}'
    echo 'Add -DauditReactive=<yourfile>.properties to select a specific configuration.'
fi

if [[ "$FRAMEWORK" == "play" ]]; then
    export SBT_OPTS=${AUDIT_OPTS}
    if [[ "$SILENT" != "true" ]]; then
        echo 'SBT_OPTS was set. You can use TypeSafe activator.'
    fi
fi

if [[ "$FRAMEWORK" == "jetty" ]]; then
    if [[ "$SILENT" != "true" ]]; then
        echo 'Use: java ${AUDIT_OPTS} -jar start.jar'
    fi
fi

if [[ "$FRAMEWORK" == "catalina" ]]; then
    export CATALINA_OPTS=${AUDIT_OPTS}
    if [[ "$SILENT" != "true" ]]; then
        echo 'CATALINA_OPTS was set. You can use "catalina run."'
    fi
fi

if [[ "$DEBUG" == "true" ]]; then
    echo AUDIT_OPTS=${AUDIT_OPTS}
fi

export AUDIT_OPTS
export AUDIT_REACTIVE_HOME

